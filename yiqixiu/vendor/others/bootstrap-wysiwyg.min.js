(function(b){var a=function(e){var c=b.Deferred(),d=new FileReader();d.onload=function(f){c.resolve(f.target.result)};d.onerror=c.reject;d.onprogress=c.notify;d.readAsDataURL(e);return c.promise()};b.fn.cleanHtml=function(){var c=b(this).html();return c&&c.replace(/(<br>|\s|<div><br><\/div>|&nbsp;)*$/,"")};b.fn.wysiwyg_destroy=function(g){var e,d,f,c;e=this;d=b.extend({},b.fn.wysiwyg.defaults,g);c="a[data-"+d.commandRole+"],button[data-"+d.commandRole+"],input[type=button][data-"+d.commandRole+"]";e.off("."+d.eventNamespace);e.off("paste");b(window).off("."+d.eventNamespace);f=b(d.toolbarSelector);f.find(c).off("."+d.eventNamespace);f.find("[data-toggle=dropdown]").off("."+d.eventNamespace);f.find("input[type=text][data-"+d.commandRole+"]").off("."+d.eventNamespace);f.find("input[type=file][data-"+d.commandRole+"]").off("."+d.eventNamespace);b("#fontFamily").off("click","a[dropdown-toggle]");return this};b.fn.wysiwyg=function(f){var g=this,m,d,c,v,q,w,k,i=function(){if(d.activeToolbarClass){b(d.toolbarSelector).find(c).each(function(){var e=b(this).data(d.commandRole);if(document.queryCommandState(e)){b(this).addClass(d.activeToolbarClass)}else{b(this).removeClass(d.activeToolbarClass)}})}},r=function(z,e){var G=z.split(" "),C=G.shift(),D=G.join(" ")+(e||"");if(C=="createLink"){var F=window.getSelection();var E=document.createRange();E.setStart(v,q);E.setEnd(w,k);F.removeAllRanges();F.addRange(E);if(window.getSelection().isCollapsed){i();return}if(e[0]=="external"){var B=document.execCommand(C,0,PREFIX_S1_URL+"eqs/link?id="+e[2]+"&url="+encodeURIComponent(e[1]));var y=window.getSelection().focusNode;while(y&&y.parentNode){y=y.parentNode;if(y.tagName&&y.tagName.toLowerCase()=="a"){y.target="_blank";b(y).removeAttr("data");break}}var A=window.getSelection().anchorNode;while(A&&A.parentNode){A=A.parentNode;if(A.tagName&&A.tagName.toLowerCase()=="a"){A.target="_blank";b(A).removeAttr("data");break}}}else{if(e[0]=="internal"){var B=document.execCommand(C,0,D.split(",")[1]);var y=window.getSelection().focusNode;while(y&&y.parentNode){y=y.parentNode;if(y.tagName&&y.tagName.toLowerCase()=="a"){b(y).attr("data",D.split(",")[1]);break}}var A=window.getSelection().anchorNode;while(A&&A.parentNode){A=A.parentNode;if(A.tagName&&A.tagName.toLowerCase()=="a"){b(A).attr("data",D.split(",")[1]);break}}}}}else{if(C==="fontSize"&&D.indexOf("px")>-1){if(!m){o()}document.execCommand(C,0,D);var x=window.getSelection().focusNode;if(m.commonAncestorContainer.contains(window.getSelection().focusNode.parentNode)){x=m.commonAncestorContainer;if(x.nodeName.toLowerCase()=="div"){x=b(x).find('[style*="font-size: -webkit-xxx-large"]')}}else{if(x.nodeName.toLowerCase()=="#text"){x=x.parentNode}}b(x).css({"fontSize":D});if(b(x).find("span").length>0){b(x).find("span").css({"fontSize":D})}return}document.execCommand(C,0,D);if(C=="fontName"){b(".font-dropdown").find(".dropdown-toggle").trigger("click")}}i()},l=function(e){b.each(e,function(x,y){g.keydown(x,function(z){if(g.attr("contenteditable")&&g.is(":visible")){z.preventDefault();z.stopPropagation();r(y)}}).keyup(x,function(z){if(g.attr("contenteditable")&&g.is(":visible")){z.preventDefault();z.stopPropagation()}})})},h=function(){var e=window.getSelection();if(e.getRangeAt&&e.rangeCount){return e.getRangeAt(0)}},o=function(){m=h()},n=function(){var x=window.getSelection();if(m){try{x.removeAllRanges()}catch(e){document.body.createTextRange().select();document.selection.empty()}x.addRange(m)}},u=function(e){g.focus();b.each(e,function(x,y){if(/^image\//.test(y.type)){b.when(a(y)).done(function(z){r("insertimage",z)}).fail(function(z){d.fileUploadError("file-reader",z)})}else{d.fileUploadError("unsupported-file-type",y.type)}})},s=function(x,e){n();if(document.queryCommandSupported("hiliteColor")){document.execCommand("hiliteColor",0,e||"transparent")}o();x.data(d.selectionMarker,e)},j=function(A,y){A.bind("click",n);b("#toolbar-add-linkA").bind("click",function(B){B.stopPropagation()});A.find(c).click(function(){n();g.focus();r(b(this).data(y.commandRole));o()});A.find(".btn-group").click(function(H){var E=window.getSelection().focusNode;while(E&&E.parentNode){E=E.parentNode;if(E.style&&E.style.fontFamily){break}else{if(E&&/editable\-text/.test(E.className)){break}}}var C,F;if(b(".size-menu:visible").length){C=b(".size-menu").find("li");if(/editable\-text/.test(E.className)){b.each(C,function(J,L){F=b(L).find("a");F.removeClass("selected-size");if(b(E).find("span").length==0){var K=b(E).find("a").css("font-size")||b(E).css("font-size");if(F.attr("data-edit")=="fontSize "+K){F.addClass("selected-size")}}else{var K=b(E).find("span").find("a").css("font-size")||b(E).find("span").css("font-size");if(F.attr("data-edit")=="fontSize "+K){F.addClass("selected-size")}}})}else{b.each(C,function(J,L){F=b(L).find("a");F.removeClass("selected-size");if(b(E).css("font-size")){var K=b(E).children().css("font-size")?b(E).children().css("font-size"):b(E).css("font-size");if(F.attr("data-edit")=="fontSize "+K){F.addClass("selected-size")}}else{if(F.attr("data-edit")=="fontSize 24px"){F.addClass("selected-size")}}})}}else{if(b(".color-menu:visible").length){C=b(".color-menu").find("li");b.each(C,function(K,L){F=b(L).find("a");var J;F.removeClass("selected-color selected-blue-color").empty();if(E.style&&E.style.color){J=E.style.color}else{if(b(E).find("a").get(0)&&b(E).find("a").get(0).style.color){J=b(E).find("a").get(0).style.color}else{if(b(E).parent("a").get(0)&&b(E).parent("a").get(0).style.color){J=b(E).parent("a").get(0).style.color}else{if(b(E).find("span").get(0)&&b(E).find("span").get(0).style.color){J=b(E).find("span").get(0).style.color}}}}J=z(J);if(F.attr("data-edit")=="foreColor "+J){F.addClass("selected-color").append('<span class="eqf-yes2"></span>');if(F.attr("data-edit")=="foreColor #23a3d3"){F.addClass("selected-blue-color")}}})}else{if(b(".bgcolor-menu:visible").length){var G;C=b(".bgcolor-menu").find("li");b.each(C,function(K,L){F=b(L).find("a");F.removeClass("selected-color").empty();if(E.style&&E.style.backgroundColor){G=E.style.backgroundColor}else{if(b(E).find("a").get(0)&&b(E).find("a").get(0).style.backgroundColor){G=b(E).find("a").get(0).style.backgroundColor}else{if(b(E).parent("a").get(0)&&b(E).parent("a").get(0).style.backgroundColor){G=b(E).parent("a").get(0).style.backgroundColor}else{if(b(E).find("span").get(0)&&b(E).find("span").get(0).style.backgroundColor){G=b(E).find("span").get(0).style.backgroundColor}}}}var J=z(F.get(0).style.backgroundColor);G=z(G);if(J==G){F.addClass("selected-color").append('<span style="" class="eqf-yes2"></span>')}})}else{if(b(".fontname-menu:visible").length){C=b(".fontname-menu").find("li");var D,I,B;b.each(C,function(J,L){var K=L.className.split(" ");D=b(L);if(D.hasClass("selected-font")){D.removeClass("selected-font")}if(!E.style){b(".weiruanyahei").addClass("selected-font")}else{if(L.className==E.style.fontFamily){D.addClass("selected-font")}}});if(!E.style){b(".weiruanyahei").addClass("selected-font")}if(E.style){if(!E.style.fontFamily){b(".weiruanyahei").addClass("selected-font")}}}}}}});function z(B){if(!B){return}B=B.match(/^rgba?[\s+]?\([\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?/i);return(B&&B.length===4)?"#"+("0"+parseInt(B[1],10).toString(16)).slice(-2)+("0"+parseInt(B[2],10).toString(16)).slice(-2)+("0"+parseInt(B[3],10).toString(16)).slice(-2):""}A.find("[data-toggle=dropdown]").click(n);var x,e;A.find(".createLink[data-toggle=dropdown]").click(function(){var C;var F=b(getSelection().focusNode).parent();e=b(F).closest(".element").attr("id");b("#btn-toolbar input[type=text][data-edit]").attr("id","input_"+e);b("#btn-toolbar select[data-edit]").attr("id","select_"+e);b("#btn-toolbar input[name=external]").attr("id","external_"+e);b("#btn-toolbar input[name=internal]").attr("id","internal_"+e);if(F.is("a")){if(F.attr("href")&&isNaN(F.attr("href"))){C=b("#btn-toolbar #input_"+e);C.val(decodeURIComponent(F.attr("href").split("url=")[1]));b("#btn-toolbar #select_"+e).val(0).attr("disabled",true);b("#btn-toolbar #external_"+e).attr("checked",true);b("#btn-toolbar #internal_"+e).attr("checked",false);x="external"}else{if(F.attr("data")||!isNaN(F.attr("href"))){C=b("#btn-toolbar #select_"+e);var D=PREFIX_URL+"m/scene/pageList/"+C.attr("sceneid")+"?date="+new Date().getTime();b.ajax({method:"GET",url:D,xhrFields:{withCredentials:true},crossDomain:true}).then(function(H){var I=H.list;if(H.success){for(var G=0;G<I.length;G++){if(I[G].id==F.attr("data")){C.val(I[G].num-1)}}}});b("#btn-toolbar #input_"+e).val("http://").attr("disabled",true);b("#btn-toolbar #internal_"+e).attr("checked",true);b("#btn-toolbar #external_"+e).attr("checked",false);x="internal"}}}else{b("#btn-toolbar #input_"+e).val("http://");b("#btn-toolbar #select_"+e).val(0).attr("disabled",true);b("#btn-toolbar #internal_"+e).attr("checked",false);b("#btn-toolbar #external_"+e).attr("checked",true);x="external"}var E=window.getSelection();var B=E.getRangeAt(0);v=B.startContainer;q=B.startOffset;w=B.endContainer;k=B.endOffset});b("#btn-toolbar input[name=external]").change(function(){x=this.value;b("#btn-toolbar #select_"+e).val(0).attr("disabled",true);b("#btn-toolbar #input_"+e).removeAttr("disabled");b("#btn-toolbar #internal_"+e).attr("checked",false)});b("#btn-toolbar input[name=internal]").change(function(){x=this.value;b("#btn-toolbar #input_"+e).val("http://").attr("disabled",true);b("#btn-toolbar #select_"+e).removeAttr("disabled");b("#btn-toolbar #external_"+e).attr("checked",false)});b("#fontFamily").on("click","a[dropdown-toggle]",function(B){n();g.focus();r(b(this).data(y.commandRole));o()});b("a[dropdown-toggle]").click(function(){if(x=="external"){var C=A.find("input[type=text][data-"+y.commandRole+"]");var E=b(C).val();b(C).val("");var B=b(C).attr("sceneid");n();var D="http://";if(!/^http:|^https:|^ftp:/.test(E)){E=D+E}if(E&&E!=D){g.focus();r(b(C).data(y.commandRole),[x,E,B])}o()}else{if(x=="internal"){var C=A.find("select[data-"+y.commandRole+"]");var E=b(C).attr("pageid");b(C).val("");var B=b(C).attr("sceneid");n();if(E){g.focus();r(b(C).data(y.commandRole),[x,parseInt(E),B])}}}});A.find("input[type=file][data-"+y.commandRole+"]").change(function(){n();if(this.type==="file"&&this.files&&this.files.length>0){u(this.files)}o();this.value=""})},p=function(){g.on("dragenter dragover",false).on("drop",function(y){var x=y.originalEvent.dataTransfer;y.stopPropagation();y.preventDefault();if(x&&x.files&&x.files.length>0){u(x.files)}})};d=b.extend({},b.fn.wysiwyg.defaults,f);c="a[data-"+d.commandRole+"],button[data-"+d.commandRole+"],input[type=button][data-"+d.commandRole+"]";l(d.hotKeys);if(d.dragAndDropImages){p()}try{document.execCommand("styleWithCSS",0,true)}catch(t){}j(b(d.toolbarSelector),d);g.attr("contenteditable",true).on("mouseup keyup mouseout",function(){o();i()});g.on("paste",function(x){x.preventDefault();var y=(x.originalEvent||x).clipboardData.getData("text/plain")||prompt("Paste something..");document.execCommand("insertText",false,y)});b(window).bind("touchend",function(A){var z=(g.is(A.target)||g.has(A.target).length>0),y=h(),x=y&&(y.startContainer===y.endContainer&&y.startOffset===y.endOffset);if(!x||z){o();i()}});return this};b.fn.wysiwyg.defaults={hotKeys:{"ctrl+b meta+b":"bold","ctrl+i meta+i":"italic","ctrl+u meta+u":"underline","ctrl+z meta+z":"undo","ctrl+y meta+y meta+shift+z":"redo","ctrl+l meta+l":"justifyleft","ctrl+r meta+r":"justifyright","ctrl+e meta+e":"justifycenter","ctrl+j meta+j":"justifyfull","shift+tab":"outdent","tab":"indent"},toolbarSelector:"[data-role=editor-toolbar]",commandRole:"edit",activeToolbarClass:"btn-info",selectionMarker:"edit-focus-marker",selectionColor:"darkgrey",dragAndDropImages:true,fileUploadError:function(d,c){console.log("File upload error",d,c)}}}(window.jQuery));